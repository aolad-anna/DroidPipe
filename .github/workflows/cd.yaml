name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main, master, develop]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment Target'
        required: true
        type: choice
        options:
          - firebase
          - play-store-internal
          - play-store-beta
          - play-store-production

jobs:
  check-ci-status:
    name: âœ… Check CI Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    outputs:
      ci-success: ${{ steps.check.outputs.success }}
    steps:
      - name: Check CI workflow status
        id: check
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… CI passed successfully"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ CI failed or was cancelled"
            exit 1
          fi

  prepare-release:
    name: ðŸŽ¯ Prepare Release
    needs: [check-ci-status]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.check-ci-status.outputs.ci-success == 'true' || 
       github.event_name == 'workflow_dispatch' || 
       startsWith(github.ref, 'refs/tags/v'))
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Get version information
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(./gradlew -q printVersion 2>/dev/null || echo "1.0.${{ github.run_number }}")
          fi
          BUILD_NUMBER=${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ”¢ Build: $BUILD_NUMBER"

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo $KEYSTORE_BASE64 | base64 -d > keystore.jks
            echo "âœ… Keystore decoded"
          else
            echo "âš ï¸ No keystore provided"
          fi

      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --stacktrace

      - name: Build Release Bundle (AAB)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew bundleRelease --stacktrace

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: Upload Release Bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 90

      - name: Upload ProGuard Mapping
        uses: actions/upload-artifact@v4
        with:
          name: mapping-files
          path: app/build/outputs/mapping/release/
          retention-days: 90

  deploy-firebase:
    name: ðŸ”¥ Deploy to Firebase
    needs: [prepare-release]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deployment_target == 'firebase' ||
      github.ref == 'refs/heads/develop' ||
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/master'
    environment:
      name: firebase-distribution
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: apk/

      - name: Deploy to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_CREDENTIALS }}
          groups: testers
          file: apk/app-release.apk
          releaseNotes: |
            ðŸš€ Build: ${{ needs.prepare-release.outputs.build-number }}
            ðŸ“ Version: ${{ needs.prepare-release.outputs.version }}
            ðŸ”€ Branch: ${{ github.ref_name }}
            ðŸ‘¤ Author: ${{ github.actor }}
            ðŸ“… Date: ${{ github.event.head_commit.timestamp }}

      - name: Notify Firebase deployment
        run: |
          echo "âœ… Successfully deployed to Firebase App Distribution"
          echo "ðŸ”— Check your Firebase Console for download link"

  deploy-play-internal:
    name: ðŸ“¦ Deploy to Play Store (Internal)
    needs: [prepare-release]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deployment_target == 'play-store-internal' ||
      github.ref == 'refs/heads/develop'
    environment:
      name: play-store-internal
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: bundle/

      - name: Download Mapping
        uses: actions/download-artifact@v4
        with:
          name: mapping-files
          path: mapping/

      - name: Deploy to Internal Testing Track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_CREDENTIALS }}
          packageName: ${{ secrets.PACKAGE_NAME }}
          releaseFiles: bundle/*.aab
          track: internal
          status: completed
          whatsNewDirectory: whatsnew/
          mappingFile: mapping/mapping.txt

      - name: Notify Internal deployment
        run: echo "âœ… Deployed to Play Store Internal Testing Track"

  deploy-play-beta:
    name: ðŸ“¦ Deploy to Play Store (Beta)
    needs: [prepare-release]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deployment_target == 'play-store-beta' ||
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/master'
    environment:
      name: play-store-beta
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: bundle/

      - name: Download Mapping
        uses: actions/download-artifact@v4
        with:
          name: mapping-files
          path: mapping/

      - name: Deploy to Beta Track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_CREDENTIALS }}
          packageName: ${{ secrets.PACKAGE_NAME }}
          releaseFiles: bundle/*.aab
          track: beta
          status: completed
          inAppUpdatePriority: 3
          whatsNewDirectory: whatsnew/
          mappingFile: mapping/mapping.txt

      - name: Notify Beta deployment
        run: echo "âœ… Deployed to Play Store Beta Track"

  deploy-play-production:
    name: ðŸš€ Deploy to Play Store (Production)
    needs: [prepare-release]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deployment_target == 'play-store-production' ||
      startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://play.google.com/store/apps/details?id=${{ secrets.PACKAGE_NAME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: bundle/

      - name: Download Mapping
        uses: actions/download-artifact@v4
        with:
          name: mapping-files
          path: mapping/

      - name: Deploy to Production Track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_CREDENTIALS }}
          packageName: ${{ secrets.PACKAGE_NAME }}
          releaseFiles: bundle/*.aab
          track: production
          status: completed
          inAppUpdatePriority: 5
          userFraction: 0.1
          whatsNewDirectory: whatsnew/
          mappingFile: mapping/mapping.txt

      - name: Notify Production deployment
        run: |
          echo "ðŸš€ Deployed to Play Store Production"
          echo "ðŸ“Š Staged rollout: 10% of users"

  create-github-release:
    name: ðŸ“ Create GitHub Release
    needs: [prepare-release, deploy-play-production]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: apk/

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: bundle/

      - name: Download Mapping
        uses: actions/download-artifact@v4
        with:
          name: mapping-files
          path: mapping/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            apk/*.apk
            bundle/*.aab
            mapping/mapping.txt
          body: |
            ## ðŸš€ Release ${{ needs.prepare-release.outputs.version }}
            
            ### ðŸ“¦ Build Information
            - **Version**: ${{ needs.prepare-release.outputs.version }}
            - **Build Number**: ${{ needs.prepare-release.outputs.build-number }}
            - **Date**: ${{ github.event.head_commit.timestamp }}
            
            ### ðŸ“¥ Downloads
            - **APK**: For direct installation
            - **AAB**: Google Play Store bundle
            - **Mapping**: ProGuard/R8 mapping file
            
            ### ðŸ”— Links
            - [View on Google Play Store](https://play.google.com/store/apps/details?id=${{ secrets.PACKAGE_NAME }})
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-deployment:
    name: ðŸ“¢ Send Notifications
    needs: [deploy-firebase, deploy-play-internal, deploy-play-beta, deploy-play-production]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.deploy-firebase.result }}" == "failure" ]] || 
             [[ "${{ needs.deploy-play-internal.result }}" == "failure" ]] || 
             [[ "${{ needs.deploy-play-beta.result }}" == "failure" ]] || 
             [[ "${{ needs.deploy-play-production.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.deploy-firebase.result }}" == "success" ]] || 
               [[ "${{ needs.deploy-play-internal.result }}" == "success" ]] || 
               [[ "${{ needs.deploy-play-beta.result }}" == "success" ]] || 
               [[ "${{ needs.deploy-play-production.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "emoji=â­ï¸" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} Deployment ${{ steps.status.outputs.status }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Status",
                      "value": "${{ steps.status.outputs.status }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "<${{ github.event.head_commit.url }}|${{ github.sha }}>",
                      "short": true
                    },
                    {
                      "title": "Author",
                      "value": "${{ github.actor }}",
                      "short": true
                    }
                  ]
                }
              ]
            }

      - name: Send Discord notification
        if: vars.DISCORD_WEBHOOK_URL != ''
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "username": "Android CD Bot",
                 "avatar_url": "https://developer.android.com/static/images/brand/Android_Robot.png",
                 "embeds": [{
                   "title": "${{ steps.status.outputs.emoji }} Deployment ${{ steps.status.outputs.status }}",
                   "color": '"$([ "${{ steps.status.outputs.status }}" == "success" ] && echo "3066993" || echo "15158332")"',
                   "fields": [
                     {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "Author", "value": "${{ github.actor }}", "inline": true},
                     {"name": "Commit", "value": "[View](${{ github.event.head_commit.url }})", "inline": true}
                   ],
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send Email notification
        if: vars.NOTIFICATION_EMAIL != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ steps.status.outputs.emoji }} Android Deployment ${{ steps.status.outputs.status }}"
          to: ${{ vars.NOTIFICATION_EMAIL }}
          from: Android CI/CD
          body: |
            Deployment Status: ${{ steps.status.outputs.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            View workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}